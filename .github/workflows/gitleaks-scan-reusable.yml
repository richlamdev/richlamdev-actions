---
name: Gitleaks Secret Scan (Reusable)

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      scan-mode:
        description: "Scan mode (latest-commit or full)"
        type: string
        required: false
      config-path:
        description: "Path to gitleaks config file"
        type: string
        required: false
      gitleaks-flags:
        description: "Additional gitleaks flags"
        type: string
        required: false
    secrets:
      GITLEAKS_LICENSE_KEY:
        description: "Gitleaks license key (required for org accounts)"
        required: false

jobs:
  scan:
    name: gitleaks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      checks: write
      id-token: write
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.scan-mode == 'full' && 0 || 2 }}
          # 2 commits for latest-commit (current + parent)
          # 0 (all history) for full scan

      - name: Run Gitleaks scan
        uses: richlamdev/richlamdev-actions/.github/actions/gitleaks-scanning@main
        env:
          GITLEAKS_LICENSE_KEY: ${{ secrets.GITLEAKS_LICENSE_KEY }}
        with:
          scan-mode: ${{ inputs.scan-mode }}
          config-path: ${{ inputs.config-path }}
          gitleaks-flags: ${{ inputs.gitleaks-flags }}
          gitleaks-license-key: ${{ secrets.GITLEAKS_LICENSE_KEY }}
